name: ğŸš€ CI/CD Pipeline - Clean Architecture

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  RAILS_ENV: test
  RUBY_VERSION: 3.4.8

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª TESTS - RSpec UNIQUEMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tests:
    name: ğŸ§ª Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: foresy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -h localhost"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§© Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler: "2.6.2"
          bundler-cache: true
          bundler-with: test

      - name: ğŸ” Validate secrets
        run: |
          if [[ -z "$SECRET_KEY_BASE" || -z "$JWT_SECRET" ]]; then
            echo "âš ï¸  Warning: Required secrets not configured"
            echo "â„¹ï¸  Some features may not work properly without secrets"
            echo "ğŸ”§ Configure secrets in Repository Settings â†’ Secrets and variables â†’ Actions"
          else
            echo "âœ… Secrets validated"
          fi
        env:
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || '' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}

      - name: ğŸ—„ï¸ Setup database
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/foresy_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || '' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}
        run: |
          bundle exec rails db:drop db:create db:schema:load
          echo "âœ… Database ready"

      - name: ğŸ§ª Run RSpec tests
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/foresy_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || '' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}
        run: |
          echo "ğŸ§ª Running RSpec with coverage..."
          bundle exec rspec \
            --format progress \
            --format RspecJunitFormatter \
            --out rspec.xml \
            --format json \
            --out coverage/rspec.json

      - name: ğŸ“Š Generate coverage report
        if: success()
        run: |
          echo "ğŸ“Š Generating coverage artifacts..."
          COVERAGE=true bundle exec rspec --format progress

      - name: ğŸ“‹ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            rspec.xml
            coverage/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”’ SÃ‰CURITÃ‰ - BRUKEMAN + BUNDLE AUDIT UNIQUEMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: tests

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§© Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler: "2.6.2"
          bundler-cache: true
          bundler-with: test

      - name: ğŸ” Brakeman Security Scan
        run: |
          echo "ğŸ” Running Brakeman security analysis..."
          bundle exec brakeman \
            --ignore-config=.brakeman.ignore \
            --no-exit-on-warn \
            --confidence-level=2
          echo "âœ… Brakeman scan completed"

      - name: ğŸ” Bundle Audit
        run: |
          echo "ğŸ” Running Bundle audit for known vulnerabilities..."
          bundle exec bundle audit check --update
          echo "âœ… Bundle audit completed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ¨ LINTING - RUBOCOP UNIQUEMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: ğŸ¨ Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: tests

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§© Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler: "2.6.2"
          bundler-cache: true
          bundler-with: test

      - name: ğŸ¨ Run RuboCop
        run: |
          echo "ğŸ¨ Running RuboCop linting..."
          bundle exec rubocop \
            --format progress \
            --format json \
            --out rubocop-report.json
        continue-on-error: false

      - name: ğŸ“‹ Upload linting results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: linting-results
          path: rubocop-report.json
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“– CONTRATS API - RSWAG UNIQUEMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  contracts:
    name: ğŸ“– API Contracts
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: tests

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: foresy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -h localhost"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§© Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler: "2.6.2"
          bundler-cache: true
          bundler-with: "development test"

      - name: ğŸ“¦ Install gems
        run: |
          echo "ğŸ” Checking bundle status..."
          bundle check || bundle install --jobs=4 --retry=3
          echo "âœ… Bundle installed"
          bundle list | grep rswag

      - name: ğŸ” Setup secrets
        env:
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || '' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}
        run: echo "âœ… Secrets configured"

      - name: ğŸ—„ï¸ Setup database
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/foresy_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || '' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}
        run: |
          bundle exec rails db:prepare
          echo "âœ… Database ready for RSwag"

      - name: ğŸ“– Generate & Validate RSwag
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/foresy_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || '' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}
        run: |
          echo "ğŸ“– Generating Swagger/OpenAPI documentation..."
          bundle exec rake rswag:specs:swaggerize

          echo "âœ… Swagger documentation generated"

      - name: ğŸ“‹ Upload API documentation
        uses: actions/upload-artifact@v4
        with:
          name: api-docs
          path: |
            swagger/v1/swagger.yaml
            doc/api/
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª TESTS E2E - CONDITIONNELS PR UNIQUEMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  e2e:
    name: ğŸ§ª End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [tests, contracts]
    if: github.event_name == 'pull_request'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: foresy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -h localhost"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§© Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler: "2.6.2"
          bundler-cache: true
          bundler-with: test

      - name: ğŸ—„ï¸ Setup database
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/foresy_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || '' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}
        run: |
          bundle exec rails db:prepare
          echo "âœ… Database ready for E2E"

      - name: ğŸ§ª Run E2E Tests
        env:
          DATABASE_URL: postgres://postgres:password@localhost:5432/foresy_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || '' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || '' }}
          E2E_MODE: true
        run: |
          echo "ğŸ§ª Running E2E acceptance tests..."
          bundle exec rspec spec/acceptance/ --format documentation
          echo "ğŸ§ª Running smoke tests..."
          if [ -f "./bin/e2e/smoke_test.sh" ]; then
            chmod +x ./bin/e2e/smoke_test.sh
            ./bin/e2e/smoke_test.sh
          fi
          echo "âœ… E2E tests completed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ QUALITY GATE - RÃ‰SUMÃ‰ FINAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: ğŸš€ Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [tests, security, lint, contracts, e2e]
    if: always()

    steps:
      - name: ğŸ“Š Summary Report
        shell: bash
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    CI/CD QUALITY GATE                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Status des jobs
          echo "ğŸ“‹ Jobs Status:"
          echo "  ğŸ§ª Tests:           ${{ needs.tests.result }}"
          echo "  ğŸ”’ Security:        ${{ needs.security.result }}"
          echo "  ğŸ¨ Linting:         ${{ needs.lint.result }}"
          echo "  ğŸ“– Contracts:       ${{ needs.contracts.result }}"
          echo "  ğŸ§ª E2E:             ${{ needs.e2e.result || 'skipped (not PR)' }}"
          echo ""

          # Validation finale
          if [[ "${{ needs.tests.result }}" == "success" &&
                "${{ needs.security.result }}" == "success" &&
                "${{ needs.lint.result }}" == "success" &&
                "${{ needs.contracts.result }}" == "success" ]]; then
            echo "ğŸ‰ ALL QUALITY GATES PASSED! âœ…"
            echo "ğŸš€ Ready for production!"
            exit 0
          else
            echo "âŒ SOME QUALITY GATES FAILED!"
            echo "ğŸ”§ Please fix the issues before merging"
            echo "Failed jobs:"
            [[ "${{ needs.tests.result }}" != "success" ]] && echo "  - Tests: ${{ needs.tests.result }}"
            [[ "${{ needs.security.result }}" != "success" ]] && echo "  - Security: ${{ needs.security.result }}"
            [[ "${{ needs.lint.result }}" != "success" ]] && echo "  - Linting: ${{ needs.lint.result }}"
            [[ "${{ needs.contracts.result }}" != "success" ]] && echo "  - Contracts: ${{ needs.contracts.result }}"
            exit 1
          fi

          echo ""
          echo "ğŸ“Š Artifacts generated:"
          echo "  ğŸ“‹ Test results: available for 7 days"
          echo "  ğŸ“Š Coverage reports: available for 7 days"
          echo "  ğŸ“– API documentation: available for 30 days"
          echo "  ğŸ¨ Linting reports: available for 7 days"
          echo ""
          echo "âœ¨ CI/CD Pipeline completed successfully!"
