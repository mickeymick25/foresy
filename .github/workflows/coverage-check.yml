name: Coverage Check

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "app/**/*.rb"
      - "spec/**/*.rb"
      - "lib/**/*.rb"
      - "Gemfile*"
      - ".github/workflows/coverage-check.yml"

jobs:
  coverage-check:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: foresy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -h localhost"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.8"
          bundler-cache: true
          bundler: "4.0.3"

      - name: Install dependencies
        run: |
          bundle install --jobs=4 --retry=3 --quiet

      - name: Install SimpleCov for coverage
        run: |
          bundle add simplecov --group test
          bundle add simplecov-json-formatter --group test
        env:
          BUNDLE_GEMFILE: Gemfile

      - name: Prepare test database
        env:
          RAILS_ENV: test
          DATABASE_URL: postgres://postgres:password@localhost:5432/foresy_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          if [[ -z "$SECRET_KEY_BASE" || -z "$JWT_SECRET" ]]; then
            echo "‚ùå Error: Required secrets are not configured"
            exit 1
          fi
          bundle exec rails db:drop db:create db:schema:load

      - name: Run tests with coverage
        env:
          RAILS_ENV: test
          DATABASE_URL: postgres://postgres:password@localhost:5432/foresy_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          COVERAGE: "true"
        run: |
          # Run RSpec with coverage enabled
          bundle exec rspec \
            --format json \
            --out coverage_results.json \
            --format documentation \
            --format SimpleCov::Formatter::JSONFormatter \
            --out coverage/coverage.json

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage/coverage.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Check minimum coverage threshold
        id: coverage-check
        run: |
          # Extract coverage percentage from JSON report
          if [ -f "coverage/coverage.json" ]; then
            COVERAGE_PERCENT=$(jq -r '.metrics.covered_percent' coverage/coverage.json 2>/dev/null || echo "0")
            FILE_COVERAGE=$(jq -r '.metrics.files | map(.covered_percent) | add / length' coverage/coverage.json 2>/dev/null || echo "0")

            echo "üìä Coverage Report:"
            echo "   Overall Coverage: ${COVERAGE_PERCENT}%"
            echo "   File Coverage: ${FILE_COVERAGE}%"

            # Check against minimum thresholds (90% overall, 80% per file)
            OVERALL_THRESHOLD=90.0
            FILE_THRESHOLD=80.0

            if (( $(echo "$COVERAGE_PERCENT < $OVERALL_THRESHOLD" | bc -l) )); then
              echo "‚ùå Coverage check failed!"
              echo "   Overall coverage: ${COVERAGE_PERCENT}% (minimum: ${OVERALL_THRESHOLD}%)"
              echo ""
              echo "üîß To fix this:"
              echo "   1. Add tests for uncovered code"
              echo "   2. Remove dead code"
              echo "   3. Update test coverage"
              echo ""
              echo "üìñ See coverage/coverage/index.html for detailed report"
              exit 1
            fi

            if (( $(echo "$FILE_COVERAGE < $FILE_THRESHOLD" | bc -l) )); then
              echo "‚ö†Ô∏è  File coverage warning!"
              echo "   Average file coverage: ${FILE_COVERAGE}% (minimum: ${FILE_THRESHOLD}%)"
              echo "   Some files may need additional test coverage"
            fi

            echo "‚úÖ Coverage check passed!"
            echo "   Overall: ${COVERAGE_PERCENT}% ‚â• ${OVERALL_THRESHOLD}%"
            echo "   Files: ${FILE_COVERAGE}% ‚â• ${FILE_THRESHOLD}%"
          else
            echo "‚ùå Coverage report not found"
            echo "   Make sure SimpleCov is properly configured"
            exit 1
          fi

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage/
            coverage_results.json
          retention-days: 30

      - name: Comment PR with coverage results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let coverageComment = '';

            // Check if coverage check passed
            if (fs.existsSync('coverage/coverage.json')) {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage.json', 'utf8'));
              const overallPercent = coverage.metrics.covered_percent || 0;
              const fileCount = coverage.metrics.files_covered || 0;
              const linesCovered = coverage.metrics.covered_lines || 0;
              const totalLines = coverage.metrics.total_lines || 0;

              const status = overallPercent >= 90.0 ? '‚úÖ' : '‚ùå';
              const statusText = overallPercent >= 90.0 ? 'PASS' : 'FAIL';

              coverageComment = `
              #### ${status} Coverage Check ${statusText}

              **Overall Coverage:** ${overallPercent.toFixed(2)}% (${linesCovered}/${totalLines} lines)

              **Files with Coverage:** ${fileCount}

              ${overallPercent >= 90.0
                ? '‚úÖ Coverage meets the 90% minimum requirement'
                : `‚ùå Coverage below 90% minimum (${overallPercent.toFixed(2)}%)

              **Actions Required:**
              - Add tests for uncovered code
              - Review coverage report in artifacts
              - Ensure all critical paths are tested`
              }

              **Coverage Report:** Available in workflow artifacts
              `;
            } else {
              coverageComment = `
              #### ‚ö†Ô∏è Coverage Check Failed

              Coverage report could not be generated. Check workflow logs for details.
              `;
            }

            // Post comment to PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: coverageComment
            });

      - name: Coverage Summary
        if: always()
        run: |
          echo "üìã Coverage Summary"
          echo "=================="
          if [ -f "coverage/coverage.json" ]; then
            OVERALL=$(jq -r '.metrics.covered_percent' coverage/coverage.json 2>/dev/null || echo "N/A")
            FILES=$(jq -r '.metrics.files_covered' coverage/coverage.json 2>/dev/null || echo "N/A")
            LINES=$(jq -r '.metrics.covered_lines' coverage/coverage.json 2>/dev/null || echo "N/A")
            TOTAL=$(jq -r '.metrics.total_lines' coverage/coverage.json 2>/dev/null || echo "N/A")

            echo "Overall Coverage: ${OVERALL}%"
            echo "Files Covered: ${FILES}"
            echo "Lines Covered: ${LINES}/${TOTAL}"
            echo ""
            echo "üìñ Detailed report: coverage/coverage/index.html"
            echo "üìä JSON report: coverage/coverage.json"
          else
            echo "‚ùå No coverage report generated"
          fi
