# Guide de Migration ADR-003 v1.4 - Authentification API Foresy

**Date de publication** : 15 janvier 2026  
**Version de l'API** : v1  
**Type de changement** : Breaking Change - Action Requise  
**Statut** : ‚ö†Ô∏è URGENT - Mise √† jour n√©cessaire avant d√©ploiement

---

## üö® R√©sum√© Ex√©cutif

L'API d'authentification Foresy a √©t√© mise √† jour selon ADR-003 v1.4 pour √©liminer l'ambigu√Øt√© des param√®tres et renforcer la s√©curit√©. **Ces changements n√©cessitent des modifications imm√©diates de votre code d'int√©gration**.

### Changements Principaux

1. **Endpoint Signup** : Structure de payload modifi√©e
2. **Endpoint Refresh Token** : Param√®tres imbriqu√©s rejet√©s
3. **Gestion d'erreurs** : Code de statut 400 au lieu de 422 pour les violations de contrat

---

## üìã Changements D√©taill√©s

### 1. Endpoint POST /api/v1/signup

#### ‚ùå Ancien Format (NO LONGER WORKS)
```json
{
  "email": "user@example.com",
  "password": "password123",
  "password_confirmation": "password123"
}
```

#### ‚úÖ Nouveau Format Requis
```json
{
  "user": {
    "email": "user@example.com",
    "password": "password123", 
    "password_confirmation": "password123"
  }
}
```

### 2. Endpoint POST /api/v1/auth/refresh

#### ‚úÖ Format Accept√© (Inchang√©)
```json
{
  "refresh_token": "your_refresh_token_here"
}
```

#### ‚ùå Format Rejet√©
```json
{
  "authentication": {
    "refresh_token": "your_refresh_token_here"
  }
}
```

### 3. Codes de Statut HTTP

| Sc√©nario | Ancien Code | Nouveau Code | Action |
|----------|-------------|--------------|---------|
| Violation de contrat | 422 Unprocessable Entity | 400 Bad Request | Mettre √† jour la gestion d'erreurs |
| Token expir√© | 401 Unauthorized | 401 Unauthorized | Aucun changement |
| Authentification r√©ussie | 201 Created | 201 Created | Aucun changement |

---

## üõ†Ô∏è Guide de Migration Pas √† Pas

### √âtape 1 : Identifier les Appels Concern√©s

Recherchez dans votre codebase :

```javascript
// Recherche pour les appels signup
fetch('/api/v1/signup', {
  method: 'POST',
  body: JSON.stringify({
    email: '...',
    password: '...',
    password_confirmation: '...'
  })
})

// Recherche pour les appels refresh
fetch('/api/v1/auth/refresh', {
  method: 'POST', 
  body: JSON.stringify({
    authentication: {
      refresh_token: '...'
    }
  })
})
```

### √âtape 2 : Mettre √† Jour les Appels Signup

#### React/JavaScript
```javascript
// AVANT
const signupData = {
  email: userEmail,
  password: userPassword,
  password_confirmation: userPasswordConfirmation
};

// APR√àS
const signupData = {
  user: {
    email: userEmail,
    password: userPassword,
    password_confirmation: userPasswordConfirmation
  }
};

const response = await fetch('/api/v1/signup', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  },
  body: JSON.stringify(signupData)
});
```

#### React Native
```javascript
// AVANT
const signupData = {
  email: userEmail,
  password: userPassword,
  password_confirmation: userPasswordConfirmation
};

// APR√àS  
const signupData = {
  user: {
    email: userEmail,
    password: userPassword,
    password_confirmation: userPasswordConfirmation
  }
};

const response = await fetch('/api/v1/signup', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  },
  body: JSON.stringify(signupData)
});
```

### √âtape 3 : V√©rifier les Appels Refresh Token

```javascript
// V√©rifiez que vous n'utilisez PAS cette structure
const badRefreshData = {
  authentication: {
    refresh_token: refreshToken
  }
};

// Utilisez uniquement cette structure
const goodRefreshData = {
  refresh_token: refreshToken
};
```

### √âtape 4 : Mettre √† Jour la Gestion d'Erreurs

#### AVANT
```javascript
if (response.status === 422) {
  // Gestion des erreurs de validation
  const errors = await response.json();
  handleValidationErrors(errors);
}
```

#### APR√àS
```javascript
if (response.status === 400) {
  // Gestion des violations de contrat
  const error = await response.json();
  handleContractViolation(error);
} else if (response.status === 422) {
  // Gestion des erreurs de validation m√©tier (toujours possible)
  const errors = await response.json();
  handleValidationErrors(errors);
}
```

---

## üß™ Tests de Validation

### Test 1 : Signup avec Nouveau Format
```javascript
const testSignup = async () => {
  const testData = {
    user: {
      email: `test_${Date.now()}@example.com`,
      password: 'password123',
      password_confirmation: 'password123'
    }
  };
  
  const response = await fetch('/api/v1/signup', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify(testData)
  });
  
  console.log('Status:', response.status);
  const result = await response.json();
  console.log('Response:', result);
};
```

### Test 2 : Rejet de l'Ancien Format
```javascript
const testOldFormatRejection = async () => {
  const oldFormatData = {
    email: 'test@example.com',
    password: 'password123',
    password_confirmation: 'password123'
  };
  
  const response = await fetch('/api/v1/signup', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify(oldFormatData)
  });
  
  console.log('Status:', response.status); // Doit √™tre 400
  const error = await response.json();
  console.log('Error:', error);
};
```

### Test 3 : Refresh Token Correct
```javascript
const testRefreshToken = async () => {
  const refreshData = {
    refresh_token: 'your_valid_refresh_token'
  };
  
  const response = await fetch('/api/v1/auth/refresh', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify(refreshData)
  });
  
  console.log('Status:', response.status);
  const result = await response.json();
  console.log('Response:', result);
};
```

---

## ‚ö†Ô∏è Erreurs Communes √† √âviter

### Erreur 1 : Oublier la Cl√© `user`
```javascript
// ‚ùå INCORRECT
{
  email: 'user@example.com',
  password: 'password123'
}

// ‚úÖ CORRECT
{
  user: {
    email: 'user@example.com', 
    password: 'password123'
  }
}
```

### Erreur 2 : Utiliser des Param√®tres Imbriqu√©s pour Refresh
```javascript
// ‚ùå INCORRECT
{
  authentication: {
    refresh_token: 'token'
  }
}

// ‚úÖ CORRECT
{
  refresh_token: 'token'
}
```

### Erreur 3 : Ne Pas Mettre √† Jour la Gestion d'Erreurs
```javascript
// ‚ùå INCOMPLET
if (response.status === 422) {
  // Ne g√®re que les anciens codes d'erreur
}

// ‚úÖ COMPLET  
if (response.status === 400) {
  // G√®re les violations de contrat (nouveau)
} else if (response.status === 422) {
  // G√®re les erreurs de validation m√©tier
}
```

---

## üìä Impact par Technologie

| Technologie | Niveau d'Impact | Temps de Migration Estim√© | Action Requise |
|-------------|------------------|---------------------------|----------------|
| React Web | ‚ö†Ô∏è Moyen | 2-4 heures | Modifier payloads + gestion d'erreurs |
| React Native | ‚ö†Ô∏è Moyen | 2-4 heures | Modifier payloads + gestion d'erreurs |
| Vue.js | ‚ö†Ô∏è Moyen | 2-4 heures | Modifier payloads + gestion d'erreurs |
| Angular | ‚ö†Ô∏è Moyen | 2-4 heures | Modifier payloads + gestion d'erreurs |
| iOS (Swift) | ‚ö†Ô∏è Moyen | 2-4 heures | Modifier payloads + gestion d'erreurs |
| Android (Kotlin) | ‚ö†Ô∏è Moyen | 2-4 heures | Modifier payloads + gestion d'erreurs |

---

## üöÄ Plan de D√©ploiement Recommand√©

### Phase 1 : Pr√©paration (1-2 jours)
1. ‚úÖ Analyser votre codebase pour identifier les endpoints concern√©s
2. ‚úÖ Cr√©er une branche de test d√©di√©e √† la migration
3. ‚úÖ Mettre √† jour les tests unitaires et d'int√©gration

### Phase 2 : Impl√©mentation (2-3 jours)
1. ‚úÖ Modifier les appels signup avec la nouvelle structure
2. ‚úÖ V√©rifier et corriger les appels refresh token  
3. ‚úÖ Mettre √† jour la gestion d'erreurs (400/422)
4. ‚úÖ Tester avec l'environnement de staging

### Phase 3 : Validation (1-2 jours)
1. ‚úÖ Ex√©cuter tous les tests automatis√©s
2. ‚úÖ Effectuer des tests manuels complets
3. ‚úÖ Valider les sc√©narios d'erreur
4. ‚úÖ Obtenir l'approbation QA

### Phase 4 : D√©ploiement (1 jour)
1. ‚úÖ D√©ployer en production pendant les heures creuses
2. ‚úÖ Surveiller les logs d'erreur pendant 24h
3. ‚úÖ Effectuer un rollback plan si n√©cessaire

---

## üìû Support et Ressources

### Documentation Technique
- **Sp√©cification OpenAPI** : `/swagger/v1/swagger.yaml`
- **Collection Postman** : `/docs/postman/Foresy_API.postman_collection.json`
- **Tests de Contrat** : `Contract Tests` folder dans Postman

### Contact Support
- **Email** : dev@foresy.com
- **Slack** : #api-support
- **Urgence** : +33.X.XX.XX.XX.XX

### Environnement de Test
- **URL Staging** : https://foresy-staging.foresy.com
- **URL Production** : https://api.foresy.com
- **Authentification** : Utilisez vos credentials de test habituels

---

## ‚úÖ Checklist de Migration

- [ ] Identifier tous les appels √† `/api/v1/signup`
- [ ] Modifier les payloads signup pour utiliser `{ user: { ... } }`
- [ ] V√©rifier que les appels refresh utilisent `{ refresh_token }`
- [ ] Mettre √† jour la gestion d'erreur pour 400 Bad Request
- [ ] Tester tous les sc√©narios avec l'environnement de staging
- [ ] Mettre √† jour les tests automatis√©s
- [ ] Valider les sc√©narios d'erreur (400 vs 422)
- [ ] Effectuer des tests manuels complets
- [ ] Planifier le d√©ploiement en production
- [ ] Surveiller les logs apr√®s d√©ploiement

---

## üìà Changelog

### Version 1.4.0 - 2026-01-15

#### Breaking Changes
- `POST /api/v1/signup` : Structure de payload modifi√©e (requiert cl√© `user`)
- `POST /api/v1/auth/refresh` : Rejet des param√®tres imbriqu√©s
- Codes d'erreur : 400 Bad Request pour violations de contrat

#### Am√©liorations
- √âlimination de l'ambigu√Øt√© des param√®tres
- Renforcement de la s√©curit√© de l'API
- Contract enforcement activ√©
- Documentation OpenAPI mise √† jour

---

**‚ö†Ô∏è ACTION REQUISE** : Veuillez effectuer ces modifications avant le d√©ploiement en production. En cas de questions, contactez imm√©diatement l'√©quipe de d√©veloppement.
```
