Une date peut Ãªtre associÃ©e Ã  plusieurs missions distinctes

UnicitÃ© stricte :

(cra_id, mission_id, date)


Violation â†’ 409 duplicate_entry

âœ”ï¸ Multi-mission / mÃªme date : autorisÃ©
âœ”ï¸ Sur-facturation contractuelle : autorisÃ©e
âœ”ï¸ Date sans entrÃ©e : autorisÃ©e

7ï¸âƒ£ CRA Lifecycle (Status)
Enum strict

draft

submitted

locked

Transitions autorisÃ©es

draft â†’ submitted

submitted â†’ locked

âš ï¸ Aucun retour arriÃ¨re
âš ï¸ Aucun changement possible aprÃ¨s locked
Violation â†’ 422 invalid_transition

8ï¸âƒ£ Business Rules & Constraints
AccÃ¨s

CRA accessible uniquement si :

user âˆˆ company independent

mission accessible (FC06)

Violation â†’ 404 not_found

UnicitÃ©

1 CRA max par (mission, month, year)
Violation â†’ 409 cra_already_exists

Modification

draft â†’ modification libre

submitted â†’ modification interdite (sauf metadata non financiÃ¨re)

locked â†’ aucune modification

Violation â†’ 409 cra_locked

Calculs (serveur only)

total_days = somme(CRAEntry.quantity)

total_amount = somme(quantity Ã— unit_price)

âš ï¸ Valeurs dÃ©rivÃ©es
âš ï¸ Jamais trustÃ©es depuis le client

Suppression

Soft delete uniquement

Interdite si CRA = submitted ou locked

Violation â†’ 409 cra_in_use

9ï¸âƒ£ Git / Versioning Contract (PLATINUM)
Principe

Chaque CRA locked est :

sÃ©rialisÃ© (JSON canonique)

versionnÃ© dans un Git repository interne

immuable

Git Object

Repository : cra-ledger

Branch : main

Commit message
CRA locked â€” mission:{id} â€” {month}/{year}

Payload versionnÃ©
{
  "cra_id": "uuid",
  "mission_id": "uuid",
  "month": 1,
  "year": 2025,
  "entries": [...],
  "totals": {...}
}


âš ï¸ Ã‰chec Git â†’ 500 internal_error
âš ï¸ CRA reste non-locked

ğŸ”Ÿ API Scope
Method	Endpoint	Description
POST	/api/v1/cras	CrÃ©er CRA
GET	/api/v1/cras	Lister
GET	/api/v1/cras/:id	DÃ©tail
PATCH	/api/v1/cras/:id	Modifier
POST	/api/v1/cras/:id/submit	Soumettre
POST	/api/v1/cras/:id/lock	Verrouiller
1ï¸âƒ£1ï¸âƒ£ Inputs / Outputs
POST /api/v1/cras
{
  "mission_id": "uuid",
  "month": 1,
  "year": 2025,
  "currency": "EUR"
}

Success â€” 201
{
  "id": "uuid",
  "status": "draft"
}

1ï¸âƒ£2ï¸âƒ£ Errors
Status	Code	Description
401	unauthorized
403	forbidden
404	not_found
409	cra_locked
409	cra_already_exists
409	duplicate_entry
422	invalid_payload
422	invalid_transition
500	internal_error
1ï¸âƒ£3ï¸âƒ£ Swagger / OpenAPI

Schemas :

cra

cra_entry

cra_with_entries

error

Enums documentÃ©s
JWT security
Exemples success & errors

1ï¸âƒ£4ï¸âƒ£ E2E Tests (OBLIGATOIRES)
Script

bin/e2e/e2e_cra_lifecycle.sh

ScÃ©nario E2E canonique

Setup independent + 2 missions

Create CRA (mission A)

Add entry (date D, mission A, quantity 0.5)

Add entry (date D, mission B, quantity 0.5)

Submit CRA

Lock CRA

Try modify â†’ 409

Verify git commit exists

âš ï¸ Aucun mock
âš ï¸ HTTP rÃ©el uniquement

1ï¸âƒ£5ï¸âƒ£ Acceptance Criteria (Gherkin)
Scenario: Lock a CRA with multi-mission entries
  Given I am authenticated as independent
  And two missions exist
  When I create a CRA
  And I add entries on the same date for different missions
  And I submit the CRA
  And I lock the CRA
  Then the CRA is immutable
  And a Git commit exists

1ï¸âƒ£6ï¸âƒ£ Definition of Done

RSpec green

E2E green

Git versioning verified

Swagger OK

Rubocop / Brakeman OK

README updated

PR ready

âœ… Ã‰TAT FINAL
Axe	Statut
Architecture	ğŸŸ¢ VerrouillÃ©e
RÃ©alisme mÃ©tier	ğŸŸ¢ Conforme
AuditabilitÃ©	ğŸŸ¢ Totale
Git Ledger	ğŸŸ¢ IntÃ©grÃ©
ScalabilitÃ©	ğŸŸ¢ Long terme
QualitÃ©	ğŸŸ¢ Platinum

ğŸ¤– PROMPT MINIMAX-M2 â€” PLATINUM

FEATURE: CRA Management (FC07)

ğŸ”¹ SYSTEM CONTEXT

You are a senior Ruby on Rails platform engineer.

You work on a Rails 8.1.1 API-only application, running in Docker.

Authentication is based on JWT tokens.

The system follows Domain-Driven Design and Relation-Driven Architecture:

Domain models are pure (no business foreign keys)

All relations are implemented via dedicated relation models

Aggregates are explicit

Auditability and determinism are mandatory

Security, correctness, immutability, and long-term auditability are non-negotiable.

You produce production-ready, CI-safe code.

ğŸ”¹ FEATURE CONTRACT (SOURCE OF TRUTH)

FEATURE NAME: CRA Management (Compte Rendu dâ€™ActivitÃ©)

ğŸ¯ GOAL

Enable an Independent to:

Declare real activity per mission

Track produced time and value

Maintain a monthly, auditable, versioned CRA

Provide the functional base for:

Invoicing

Fiscal reporting

Long-term analytics

A CRA is a legal and contractual artifact, immutable once locked.

ğŸ‘¤ ACTORS
Primary Actor

Authenticated User (JWT)

Business Preconditions

User belongs to a Company with role independent

Mission is accessible to the user (FC06 rules)

Violations:

Role incoherence â†’ 403 forbidden

Mission not accessible â†’ 404 not_found

ğŸ§± ARCHITECTURAL PRINCIPLES (STRICT)

âŒ No business foreign keys in Domain Models

âœ… All relations via Relation Models

Domain entities are pure

Relations are auditable and versionable

CRA is the aggregate root

ğŸ“¦ DOMAIN MODELS (PURE)
CRA

Fields:

id (UUID)

month (1â€“12)

year

status: draft | submitted | locked

total_days (calculated)

total_amount (calculated)

currency (ISO 4217)

created_at

updated_at

locked_at

deleted_at (soft delete)

âš ï¸ No reference to Mission, Company, or User

CRAEntry

Fields:

id (UUID)

date (Date)

quantity (Decimal)

unit_price (Integer)

description (Text)

created_at

updated_at

deleted_at

Quantity rules:

Represents declared billable quantity for a mission on a given date

Unit: day

Granularity allowed (e.g. 0.25, 0.5, 1.0, 2.0)

No upper bound validation

âš ï¸ No moral or time-based validation allowed

ğŸ”— RELATION MODELS (MANDATORY)
CRAMission

cra_id

mission_id

Constraints:

One CRA belongs to exactly one mission

One mission has max one CRA per (month, year)

CRAEntryCRA

cra_id

cra_entry_id

Constraints:

Multiple entries allowed on the same date

Same date can be associated with multiple missions

Uniqueness constraint:

(cra_id, mission_id, date)


Violation â†’ 409 duplicate_entry

ğŸ” CRA LIFECYCLE

Statuses:

draft

submitted

locked

Allowed transitions:

draft â†’ submitted

submitted â†’ locked

Rules:

No rollback

No modification after locked

Violation â†’ 422 invalid_transition

ğŸ“œ BUSINESS RULES
Access

CRA accessible only if:

User âˆˆ company independent

Mission accessible (FC06)

Else â†’ 404 not_found

Uniqueness

1 CRA max per (mission, month, year)
â†’ 409 cra_already_exists

Modification

draft â†’ free

submitted â†’ metadata only (non-financial)

locked â†’ immutable

Violation â†’ 409 cra_locked

Calculations (Server-side only)

total_days = Î£ CRAEntry.quantity

total_amount = Î£(quantity Ã— unit_price)

Client values are never trusted.

Deletion

Soft delete only

Forbidden if submitted or locked

Violation â†’ 409 cra_in_use

ğŸ§¬ GIT / VERSIONING CONTRACT (PLATINUM)

On CRA lock:

Serialize CRA into canonical JSON

Commit into internal Git repository

Git specs:

Repository: cra-ledger

Branch: main

Commit message:

CRA locked â€” mission:{id} â€” {month}/{year}


Failure:

Git error â†’ 500 internal_error

CRA remains unlocked

ğŸŒ API SCOPE

Endpoints:

POST /api/v1/cras

GET /api/v1/cras

GET /api/v1/cras/:id

PATCH /api/v1/cras/:id

POST /api/v1/cras/:id/submit

POST /api/v1/cras/:id/lock

ğŸ§ª E2E TESTS (MANDATORY)

Script:
bin/e2e/e2e_cra_lifecycle.sh

Canonical E2E scenario:

Setup independent + two missions

Create CRA

Add entries on same date for different missions

Submit CRA

Lock CRA

Attempt modification â†’ 409

Verify Git commit exists

Constraints:

No mocks

Real HTTP calls only

CI-safe

Deterministic

âœ… ACCEPTANCE CRITERIA (GHERKIN)
Scenario: Lock a CRA with multi-mission entries
  Given I am authenticated as independent
  And two missions exist
  When I create a CRA
  And I add entries on the same date for different missions
  And I submit the CRA
  And I lock the CRA
  Then the CRA is immutable
  And a Git commit exists

ğŸ”§ TASK

Implement full backend support for CRA Management strictly following this contract.

Requirements:

Rails models

Relation models

Controllers

Validations

Lifecycle enforcement

Git ledger integration

Swagger/OpenAPI

RSpec tests

E2E script

ğŸ“¤ OUTPUT FORMAT

Return:

Production-ready code

E2E script

Swagger schemas

Do NOT:

Add undocumented features

Change lifecycle rules

Add foreign keys to domain models

Mock anything
