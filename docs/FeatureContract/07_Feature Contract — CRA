ğŸ§¾ FEATURE CONTRACT 07 â€” CRA

Compte Rendu dâ€™ActivitÃ©

âš ï¸ DOCUMENT CONTRACTUEL â€” SOURCE DE VÃ‰RITÃ‰
âš ï¸ Toute ambiguÃ¯tÃ© DOIT Ãªtre signalÃ©e avant implÃ©mentation
âš ï¸ Aucune dÃ©viation autorisÃ©e

1ï¸âƒ£ Feature Name

CRA Management (Compte Rendu dâ€™ActivitÃ©)

2ï¸âƒ£ Business Goal

Permettre Ã  un IndÃ©pendant de :

dÃ©clarer son activitÃ© rÃ©elle par mission

suivre son temps / valeur produite

disposer dâ€™un historique mensuel fiable, auditable et versionnÃ©

Fournir le socle :

de la facturation

du pilotage fiscal

des reportings long terme

ğŸ‘‰ Le CRA est un artefact lÃ©gal et contractuel, immutabilisÃ© dans le temps.

3ï¸âƒ£ Actors
Primary Actor

Authenticated User (JWT)

PrÃ©-requis mÃ©tier

Lâ€™utilisateur appartient Ã  une Company avec rÃ´le independent

Les missions rÃ©fÃ©rencÃ©es sont accessibles Ã  lâ€™utilisateur (rÃ¨gles FC06)

âš ï¸ Toute incohÃ©rence â†’ 403 forbidden
âš ï¸ Mission non accessible â†’ 404 not_found

4ï¸âƒ£ Architectural Principles (NON NÃ‰GOCIABLES)

ğŸ§± Domain-Driven / Relation-Driven

âŒ Aucune clÃ© Ã©trangÃ¨re mÃ©tier dans les Domain Models
âœ… Toutes les relations passent par des Relation Models dÃ©diÃ©s

EntitÃ©s mÃ©tiers pures

Relations auditables, versionnables

CRA = agrÃ©gat racine

5ï¸âƒ£ Domain Models (purs)
CRA
Champ	Type	Required	Notes
id	UUID	Yes
month	Integer	Yes	1â€“12
year	Integer	Yes
status	Enum	Yes	draft | submitted | locked
description	Text	No	ğŸ†• Metadata non financiÃ¨re
total_days	Decimal	No	CalculÃ©
total_amount	Integer	No	CalculÃ©
currency	String	Yes	ISO 4217
created_by_user_id	UUID	Yes	ğŸ†• Audit-only
created_at	DateTime	Yes
updated_at	DateTime	Yes
locked_at	DateTime	No
deleted_at	DateTime	No	Soft delete

âš ï¸ Aucune rÃ©fÃ©rence mÃ©tier vers Mission / Company
âš ï¸ created_by_user_id est audit-only, non relation mÃ©tier
âš ï¸ description :

modifiable en draft

modifiable en submitted

figÃ©e en locked

CRAEntry
Champ	Type	Required	Notes
id	UUID	Yes
date	Date	Yes
quantity	Decimal	Yes	QuantitÃ© facturable
unit_price	Integer	Yes	En cents
description	Text	No
created_at	DateTime	Yes
updated_at	DateTime	Yes
deleted_at	DateTime	No
ğŸ”‘ DÃ©finition contractuelle de quantity

ReprÃ©sente la quantitÃ© facturable dÃ©clarÃ©e

UnitÃ© : journÃ©e

GranularitÃ© libre (ex : 0.25, 0.5, 1.0, 2.0)

Aucune borne supÃ©rieure mÃ©tier cÃ´tÃ© backend

âš ï¸ EntitÃ© strictement mÃ©tier
âš ï¸ Aucune validation â€œmoraleâ€ du temps nâ€™est autorisÃ©e

6ï¸âƒ£ Relation Models (OBLIGATOIRES)
CRAMission
Champ	Type	Required
id	UUID	Yes
cra_id	UUID	Yes
mission_id	UUID	Yes
created_at	DateTime	Yes

ğŸ”’ Contraintes

Un CRA peut Ãªtre liÃ© Ã  plusieurs missions

Une mission ne peut apparaÃ®tre quâ€™une seule fois dans un CRA

ğŸ†• RÃ¨gle de crÃ©ation

Le lien CRAMission est crÃ©Ã© automatiquement

DÃ©clenchÃ© lors de la premiÃ¨re CRAEntry associÃ©e Ã  la mission

CentralisÃ© via un service mÃ©tier (CraMissionLinker)

Aucun endpoint dÃ©diÃ© exposÃ©

CRAEntryCRA
Champ	Type	Required
id	UUID	Yes
cra_id	UUID	Yes
cra_entry_id	UUID	Yes
created_at	DateTime	Yes
CRAEntryMission
Champ	Type	Required
id	UUID	Yes
cra_entry_id	UUID	Yes
mission_id	UUID	Yes
created_at	DateTime	Yes
ğŸ”’ Contraintes mÃ©tier sur les entrÃ©es

Un CRA peut contenir plusieurs CRAEntry pour une mÃªme date

Une date peut Ãªtre associÃ©e Ã  plusieurs missions distinctes

Une mission peut apparaÃ®tre plusieurs fois dans un CRA sur des dates diffÃ©rentes

UnicitÃ© stricte
(cra_id, mission_id, date)


Validation mÃ©tier (service-level)

Violation â†’ 409 duplicate_entry

âœ”ï¸ Multi-mission / mÃªme date : autorisÃ©
âœ”ï¸ Sur-facturation contractuelle : autorisÃ©e
âœ”ï¸ Date sans entrÃ©e : autorisÃ©e

7ï¸âƒ£ CRA Lifecycle (Status)
Enum strict

draft

submitted

locked

Transitions autorisÃ©es

draft â†’ submitted

submitted â†’ locked

âš ï¸ Aucun retour arriÃ¨re
âš ï¸ Aucun changement possible aprÃ¨s locked
Violation â†’ 422 invalid_transition

8ï¸âƒ£ Business Rules & Constraints
AccÃ¨s

CRA accessible uniquement si :

user âˆˆ company independent

missions accessibles (FC06)

Violation â†’ 404 not_found

UnicitÃ©

1 CRA max par (user, month, year)

Violation â†’ 409 cra_already_exists

ğŸ†• Contrainte DB obligatoire

Index unique (created_by_user_id, month, year)

FiltrÃ© sur deleted_at IS NULL

ProtÃ¨ge des race conditions concurrentes

Modification

draft â†’ modification libre

submitted â†’ modification interdite sauf metadata non financiÃ¨re

locked â†’ aucune modification

ğŸ†• Metadata non financiÃ¨re autorisÃ©e en submitted

description (CRA-level uniquement)

âŒ Toute modification financiÃ¨re ou dâ€™entry en submitted est interdite
Violation â†’ 409 cra_locked

Calculs (serveur only)

total_days = somme(CRAEntry.quantity)

total_amount = somme(quantity Ã— unit_price)

ğŸ†• Les totaux sont recalculÃ©s :

Ã  chaque crÃ©ation / modification / suppression dâ€™entry

lors du submit

lors du lock

âš ï¸ Valeurs dÃ©rivÃ©es
âš ï¸ Jamais trustÃ©es depuis le client

Suppression

Soft delete uniquement

Interdite si CRA = submitted ou locked

Violation â†’ 409 cra_in_use

ğŸ†• Soft-delete cascade

Soft-delete du CRA entraÃ®ne :

soft-delete des CRAEntry

soft-delete des relations (CRAMission, CRAEntryCRA, CRAEntryMission)

9ï¸âƒ£ Git / Versioning Contract (PLATINUM)
Principe

Chaque CRA verrouillÃ© (locked) est :

sÃ©rialisÃ© dans un JSON canonique

versionnÃ© dans un Git repository interne

considÃ©rÃ© comme immuable

Le Git Ledger constitue une preuve dâ€™audit indÃ©pendante du stockage applicatif.

âš ï¸ Un CRA ne DOIT PAS passer au statut locked si lâ€™Ã©criture Git Ã©choue.

ğŸ†• [AJOUT] â€” PortÃ©e contractuelle

Le Git Ledger est une source dâ€™audit secondaire contractuelle, indÃ©pendante :

de la base de donnÃ©es applicative

des mÃ©canismes ORM

Il ne remplace pas la base applicative, mais en constitue une preuve append-only vÃ©rifiable.

Git Object

Repository : cra-ledger

Branch : main

Path local : /app/cra-ledger

Le repository est :

auto-initialisÃ© au boot sâ€™il est absent

append-only (aucune rÃ©Ã©criture de lâ€™historique)

ğŸ†• [AJOUT] â€” Contraintes Git

âŒ git rebase, git commit --amend, git push --force strictement interdits

âŒ suppression de commits interdite

Toute tentative de rÃ©Ã©criture de lâ€™historique constitue une violation contractuelle

Environnements & Persistance
MVP / Environnements non-production (DEV, STAGING)

Le filesystem est Ã©phÃ©mÃ¨re

Le Git Ledger est considÃ©rÃ© comme un bonus d'audit

La perte du dossier lors d'un redeploy est acceptÃ©e

Les donnÃ©es source restent en base de donnÃ©es

ğŸ‘‰ Ce mode est explicitement autorisÃ© hors production.

ğŸ†• Production â€” DÃ‰CISION CTO CONFIRMÃ‰E âœ…
âœ… Option A â€” Volume persistant (Render Disk) OBLIGATOIRE

Le dossier /app/cra-ledger est montÃ© sur un filesystem persistant

Les commits Git DOIVENT survivre aux redeploys

Le Git Ledger constitue une preuve d'audit durable, indÃ©pendante et opposable

Cette configuration est obligatoire en production.

Toute perte du Git Ledger en production est considÃ©rÃ©e comme un incident critique.

âŒ Option B â€” Filesystem Ã©phÃ©mÃ¨re

Strictement interdite en production

AutorisÃ©e uniquement pour :

MVP

DEV

STAGING

âš ï¸ L'option B ne peut Ãªtre utilisÃ©e en production sous aucune circonstance.

Git Identity (technique)

Les commits sont rÃ©alisÃ©s avec une identitÃ© technique dÃ©diÃ©e :

name : foresy-ledger

email : ledger@foresy.internal

Aucune identitÃ© utilisateur mÃ©tier ne doit apparaÃ®tre dans lâ€™historique Git.

ğŸ†• [AJOUT] â€” RÃ¨gle de traÃ§abilitÃ©

Lâ€™identitÃ© Git ne doit jamais dÃ©pendre :

de lâ€™utilisateur courant

du contexte mÃ©tier

La traÃ§abilitÃ© utilisateur reste assurÃ©e uniquement via le payload JSON

Commit
Message de commit
CRA locked â€” cra:{id} â€” {month}/{year}


ğŸ†• [AJOUT] â€” UnicitÃ©

Il doit exister exactement un commit Git par CRA verrouillÃ©

Aucun commit intermÃ©diaire nâ€™est autorisÃ© pour un mÃªme CRA

Payload versionnÃ© (JSON canonique)
{
  "cra_id": "uuid",
  "month": 1,
  "year": 2025,
  "missions": ["uuid", "uuid"],
  "entries": [...],
  "totals": {
    "total_days": 1.0,
    "total_amount": 800
  }
}


ğŸ†• [AJOUT] â€” Canonical JSON

Ordre des clÃ©s stable et dÃ©terministe

Aucune donnÃ©e calculÃ©e cÃ´tÃ© client

Le payload reprÃ©sente lâ€™Ã©tat exact du CRA au moment du lock

âš ï¸ Gestion des erreurs

Ã‰chec Git â†’ 500 internal_error

Rollback complet

Le CRA reste non-locked

Aucun Ã©tat intermÃ©diaire nâ€™est tolÃ©rÃ©

ğŸ†• [AJOUT] â€” ObservabilitÃ©

Toute erreur Git doit Ãªtre :

loggÃ©e cÃ´tÃ© serveur

corrÃ©lable avec lâ€™ID du CRA

ğŸ†• TransactionnalitÃ© stricte (OBLIGATOIRE)

Le verrouillage du CRA DOIT Ãªtre atomique :

recalcul des totaux

passage du statut Ã  locked

commit Git

Toute erreur Git provoque :

une exception bloquante

un rollback total

aucune persistance partielle

ğŸ†• [AJOUT] â€” Contrat technique

Cette transaction est implÃ©mentÃ©e dans un service applicatif dÃ©diÃ©

âŒ Aucune logique de lock ou Git dans le contrÃ´leur

âŒ Aucun contournement possible via API ou job async

ğŸ”Ÿ API Scope
Method	Endpoint	Description
POST	/api/v1/cras	CrÃ©er CRA
GET	/api/v1/cras	Lister (paginated)
GET	/api/v1/cras/:id	DÃ©tail
PATCH	/api/v1/cras/:id	Modifier
DELETE	/api/v1/cras/:id	Soft delete
POST	/api/v1/cras/:id/submit	Soumettre
POST	/api/v1/cras/:id/lock	Verrouiller
ğŸ†• Pagination GET /api/v1/cras

ParamÃ¨tres :

page (default: 1)

per_page (default: 20)

RÃ©ponse :

{
  "data": [...],
  "meta": {
    "total": 120,
    "page": 1,
    "per_page": 20
  }
}

ğŸ†• Endpoints CRAEntry
Method	Endpoint	Description
POST	/api/v1/cras/:cra_id/entries	Ajouter une entrÃ©e
GET	/api/v1/cras/:cra_id/entries	Lister les entrÃ©es
PATCH	/api/v1/cras/:cra_id/entries/:id	Modifier une entrÃ©e
DELETE	/api/v1/cras/:cra_id/entries/:id	Supprimer une entrÃ©e
1ï¸âƒ£1ï¸âƒ£ Inputs / Outputs
POST /api/v1/cras
{
  "month": 1,
  "year": 2025,
  "currency": "EUR"
}


Success â€” 201

{
  "id": "uuid",
  "status": "draft"
}

1ï¸âƒ£2ï¸âƒ£ Errors
Status	Code	Description
401	unauthorized
403	forbidden
404	not_found
409	cra_locked
409	cra_already_exists
409	duplicate_entry
422	invalid_payload
422	invalid_transition
500	internal_error

ğŸ†• Error payload standard

{
  "error": "duplicate_entry",
  "message": "An entry already exists for this mission and date in this CRA."
}

1ï¸âƒ£3ï¸âƒ£ Swagger / OpenAPI

Schemas :

cra

cra_entry

cra_with_entries

error

Enums documentÃ©s

JWT security

Exemples success & errors

1ï¸âƒ£4ï¸âƒ£ E2E Tests (OBLIGATOIRES)

Script
bin/e2e/e2e_cra_lifecycle.sh

ScÃ©nario E2E canonique

Setup independent + 2 missions

Create CRA

Add entry (date D, mission A, quantity 0.5)

Add entry (date D, mission B, quantity 0.5)

Submit CRA

Lock CRA

Try modify â†’ 409

Verify git commit exists

âš ï¸ Aucun mock
âš ï¸ HTTP rÃ©el uniquement

1ï¸âƒ£5ï¸âƒ£ Acceptance Criteria (Gherkin)
Scenario: Lock a CRA with multi-mission entries
  Given I am authenticated as independent
  And two missions exist
  When I create a CRA
  And I add entries on the same date for different missions
  And I submit the CRA
  And I lock the CRA
  Then the CRA is immutable
  And a Git commit exists

1ï¸âƒ£6ï¸âƒ£ Definition of Done

RSpec green

E2E green

Git versioning verified

Swagger OK

Rubocop / Brakeman OK

README updated

PR ready

1ï¸âƒ£7ï¸âƒ£ Test Strategy & TDD Contract (PLATINUM)
Principe gÃ©nÃ©ral

Le dÃ©veloppement de FC07 est soumis Ã  un TDD strict et obligatoire.

Aucune implÃ©mentation nâ€™est acceptÃ©e si elle nâ€™est pas :

couverte par des tests automatisÃ©s

Ã©crite aprÃ¨s lâ€™expression du comportement attendu

HiÃ©rarchie des tests (OBLIGATOIRE)

Domain Tests (prioritaires)

RÃ¨gles mÃ©tier pures

Calculs (total_days, total_amount)

UnicitÃ© (cra_id, mission_id, date)

Lifecycle (draft â†’ submitted â†’ locked)

Interdictions de modification

âŒ Aucun test de domaine ne doit dÃ©pendre :

du contrÃ´leur

du routing

du HTTP

Service / Use-Case Tests

Lock transactionnel

Recalcul des totaux

GitLedgerService

Rollback en cas dâ€™Ã©chec Git

Request Specs (API)

Contrats HTTP

Codes dâ€™erreur

Payloads

E2E Tests (obligatoires)

ScÃ©nario canonique dÃ©crit en section 1ï¸âƒ£4ï¸âƒ£

Aucun mock

HTTP rÃ©el uniquement

RÃ¨gles TDD non nÃ©gociables

âŒ Aucun code mÃ©tier dans les contrÃ´leurs

âŒ Aucun test â€œhappy-path onlyâ€

âŒ Aucun mock de logique mÃ©tier

âœ… Tests Ã©crits avant ou en mÃªme temps que le code

âœ… Toute rÃ©gression doit Ãªtre couverte par un test reproduisant le bug

CritÃ¨re de rejet automatique

Une PR FC07 est rejetÃ©e automatiquement si :

une rÃ¨gle mÃ©tier nâ€™est pas couverte par un test

un test contourne le domaine (ex: validation en contrÃ´leur)

une rÃ¨gle est testÃ©e uniquement en E2E sans test de domaine

âœ… Ã‰TAT FINAL
Axe	Statut
Architecture	ğŸŸ¢ VerrouillÃ©e
RÃ©alisme mÃ©tier	ğŸŸ¢ Conforme
AuditabilitÃ©	ğŸŸ¢ Totale
Git Ledger	ğŸŸ¢ IntÃ©grÃ©
ScalabilitÃ©	ğŸŸ¢ Long terme
QualitÃ©	ğŸŸ¢ Platinum

ğŸ¤– PROMPT MINIMAX-M2 â€” PLATINUM

FEATURE: CRA Management (FC07)

ğŸ”¹ SYSTEM CONTEXT

You are a senior Ruby on Rails platform engineer.

You work on a Rails 8.1.1 API-only application, running in Docker.

Authentication is based on JWT tokens.

The system follows Domain-Driven Design and Relation-Driven Architecture:

Domain models are pure (no business foreign keys)

All relations are implemented via dedicated relation models

Aggregates are explicit

Auditability and determinism are mandatory

Security, correctness, immutability, and long-term auditability are non-negotiable.

You produce production-ready, CI-safe code.

ğŸ”¹ FEATURE CONTRACT (SOURCE OF TRUTH)
FEATURE NAME

CRA Management (Compte Rendu dâ€™ActivitÃ©)

ğŸ¯ GOAL

Enable an Independent to:

Declare real activity per mission

Track produced time and value

Maintain a monthly, auditable, versioned CRA

Provide the functional base for:

Invoicing

Fiscal reporting

Long-term analytics

A CRA is a legal and contractual artifact, immutable once locked.

ğŸ‘¤ ACTORS
Primary Actor

Authenticated User (JWT)

Business Preconditions

User belongs to a Company with role independent

Missions referenced are accessible to the user (FC06 rules)

Violations

Role incoherence â†’ 403 forbidden

Mission not accessible â†’ 404 not_found

ğŸ§± ARCHITECTURAL PRINCIPLES (STRICT)

âŒ No business foreign keys in Domain Models
âœ… All relations via Relation Models

Domain entities are pure

Relations are auditable and versionable

CRA is the aggregate root

ğŸ“¦ DOMAIN MODELS (PURE)
CRA

Fields

id (UUID)

month (1â€“12)

year

status: draft | submitted | locked

description (Text, nullable) ğŸ†•

total_days (Decimal, calculated)

total_amount (Integer, calculated)

currency (ISO 4217)

created_by_user_id (UUID) ğŸ†• (audit-only)

created_at

updated_at

locked_at

deleted_at (soft delete)

âš ï¸ No reference to Mission or Company
âš ï¸ created_by_user_id is audit-only, not a business relation

ğŸ†• Description rules

Editable in draft

Editable in submitted

Frozen in locked

CRAEntry

Fields

id (UUID)

date (Date)

quantity (Decimal)

unit_price (Integer, cents)

description (Text)

created_at

updated_at

deleted_at

Quantity rules

Represents declared billable quantity

Unit: day

Granularity allowed (e.g. 0.25, 0.5, 1.0, 2.0)

No upper bound validation

No moral or time-based validation

âš ï¸ Domain-pure entity
âš ï¸ Backend must not enforce â€œâ‰¤ 1 dayâ€ constraints

ğŸ”— RELATION MODELS (MANDATORY)
CRAMission

Fields

id

cra_id

mission_id

created_at

Constraints

A CRA can be linked to multiple missions

A mission can appear only once per CRA

ğŸ†• Creation rule

CRAMission is created automatically

Triggered on the first CRAEntry linked to a mission

Centralized via a service (e.g. CraMissionLinker)

No dedicated endpoint is exposed

CRAEntryCRA

Fields

id

cra_id

cra_entry_id

created_at

CRAEntryMission

Fields

id

cra_entry_id

mission_id

created_at

Entry Constraints

A CRA may contain multiple entries on the same date

A date may be associated with multiple missions

A mission may appear multiple times across dates

âœ” Multi-mission billing on the same date is allowed
âœ” Over-billing is contractually allowed
âœ” Empty dates are allowed

Strict uniqueness

(cra_id, mission_id, date)


Enforced via service-level validation

Cannot rely on a single DB index due to relation models

Violation â†’ 409 duplicate_entry

ğŸ” CRA LIFECYCLE
Statuses

draft

submitted

locked

Allowed transitions

draft â†’ submitted

submitted â†’ locked

Rules

No rollback

No modification after locked

Violation â†’ 422 invalid_transition

ğŸ“œ BUSINESS RULES
Access

CRA accessible only if:

User âˆˆ company independent

Referenced missions are accessible (FC06)

Else â†’ 404 not_found

Uniqueness

1 CRA max per (user, month, year)

Violation â†’ 409 cra_already_exists

ğŸ†• Database-level protection

Unique index on (created_by_user_id, month, year)

Scoped to deleted_at IS NULL

Prevents race conditions

Modification

draft â†’ free modification

submitted â†’ metadata only (non-financial)

locked â†’ immutable

ğŸ†• Metadata allowed in submitted

CRA-level description only

Violation â†’ 409 cra_locked

Calculations (Server-side only)

total_days = Î£ CRAEntry.quantity

total_amount = Î£(quantity Ã— unit_price)

ğŸ†• Totals must be recalculated

on entry create / update / delete

on submit

on lock

âš ï¸ Client values are never trusted

Deletion

Soft delete only

Forbidden if submitted or locked

Violation â†’ 409 cra_in_use

ğŸ†• Soft-delete cascade

Soft-deleting a CRA also soft-deletes:

CRAEntry

CRAMission

CRAEntryCRA

CRAEntryMission

ğŸ§¬ GIT / VERSIONING CONTRACT (PLATINUM)

On CRA lock:

Serialize CRA into canonical JSON

Commit into internal Git repository

Commit is immutable

Git specs

Repository: cra-ledger

Branch: main

Local path: /app/cra-ledger

Repo auto-initialized if missing

Git identity (technical)

name: foresy-ledger

email: ledger@foresy.internal

Commit message

CRA locked â€” cra:{id} â€” {month}/{year}


Versioned payload

{
  "cra_id": "uuid",
  "month": 1,
  "year": 2025,
  "missions": ["uuid", "uuid"],
  "entries": [...],
  "totals": {
    "total_days": 1.0,
    "total_amount": 800
  }
}


Failure semantics

Git error â†’ 500 internal_error

CRA remains unlocked

ğŸ†• Transactional guarantee

CRA lock, totals recalculation and Git commit are executed in a single DB transaction

Any Git failure triggers a full rollback

ğŸ†• Production â€” CTO DECISION CONFIRMED âœ…
âœ… Option A â€” Persistent Volume (Render Disk) MANDATORY

The /app/cra-ledger directory is mounted on persistent filesystem

Git commits MUST survive redeploys

Git Ledger constitutes durable, independent and enforceable audit proof

This configuration is mandatory in production.

Any loss of Git Ledger in production is considered a critical incident.

âŒ Option B â€” Ephemeral Filesystem

Strictly forbidden in production

Allowed only for:

MVP

DEV

STAGING

âš ï¸ Option B cannot be used in production under any circumstance.

ğŸŒ API SCOPE
CRA Endpoints

POST /api/v1/cras

GET /api/v1/cras ğŸ†• (paginated)

GET /api/v1/cras/:id

PATCH /api/v1/cras/:id

DELETE /api/v1/cras/:id ğŸ†• (soft delete)

POST /api/v1/cras/:id/submit

POST /api/v1/cras/:id/lock

ğŸ†• Pagination contract

Params:

page (default 1)

per_page (default 20)

Response shape:

{
  "data": [...],
  "meta": {
    "total": 120,
    "page": 1,
    "per_page": 20
  }
}

ğŸ†• CRAEntry Endpoints

POST /api/v1/cras/:cra_id/entries

GET /api/v1/cras/:cra_id/entries

PATCH /api/v1/cras/:cra_id/entries/:id

DELETE /api/v1/cras/:cra_id/entries/:id

ğŸ§ª E2E TESTS (MANDATORY)

Script:

bin/e2e/e2e_cra_lifecycle.sh


Canonical E2E scenario:

Setup independent + two missions

Create CRA

Add entry (date D, mission A, quantity 0.5)

Add entry (date D, mission B, quantity 0.5)

Submit CRA

Lock CRA

Attempt modification â†’ 409

Verify Git commit exists

Constraints:

No mocks

Real HTTP calls only

CI-safe

Deterministic

âœ… ACCEPTANCE CRITERIA (GHERKIN)

Scenario: Lock a CRA with multi-mission entries

Given I am authenticated as independent
And two missions exist
When I create a CRA
And I add entries on the same date for different missions
And I submit the CRA
And I lock the CRA
Then the CRA is immutable
And a Git commit exists

ğŸ”§ TASK

Implement full backend support for CRA Management strictly following this contract.

Requirements:

Rails models

Relation models

Controllers

Validations

Lifecycle enforcement

Git ledger integration

Swagger / OpenAPI

RSpec tests

E2E script

ğŸ§ª TEST STRATEGY â€” TDD STRICT (PLATINUM) ğŸ†•
Mandatory TDD Contract

This feature MUST be implemented using strict Test-Driven Development (TDD).

No production code is acceptable unless:

the expected behavior is first expressed as a test

the test fails before implementation

the test passes after implementation

Test Hierarchy (NON-NEGOTIABLE)
1ï¸âƒ£ Domain Specs

CRA lifecycle

Entry uniqueness

Totals calculation

Immutability

Soft-delete rules

âŒ No HTTP
âŒ No controllers
âŒ No mocks of domain logic

2ï¸âƒ£ Service / Use-Case Specs

Entry services

CraMissionLinker

Transactional CRA lock

GitLedgerService rollback on failure

3ï¸âƒ£ Request Specs

All endpoints

Error codes and payloads

Controllers delegate to services only

4ï¸âƒ£ E2E Tests

Real HTTP

Real DB

Real Git

No mocks

Forbidden Practices

Business logic in controllers

Skipping domain specs

Mocking domain behavior

Fixing bugs without tests

Acceptance Gate

PR must be rejected if:

Any business rule lacks a domain spec

Git transactionality is not test-covered

Lifecycle rules are only tested via HTTP

ğŸ“¤ OUTPUT FORMAT

Return:

Production-ready code

E2E script

Swagger schemas

Do NOT:

Add undocumented features

Change lifecycle rules

Add foreign keys to domain models

Mock anything
