ğŸ§¾ FEATURE CONTRACT 06 â€” MISSIONS

(Domain-Driven / Relation-Driven Architecture)

âš ï¸ DOCUMENT CONTRACTUEL â€” SOURCE DE VÃ‰RITÃ‰
âš ï¸ Toute ambiguÃ¯tÃ© DOIT Ãªtre signalÃ©e avant implÃ©mentation
âš ï¸ Aucune dÃ©viation autorisÃ©e

1ï¸âƒ£ Feature Name

Mission Management

2ï¸âƒ£ Business Goal

Permettre Ã  un IndÃ©pendant de :

crÃ©er et gÃ©rer ses missions professionnelles

structurer son activitÃ© contractuelle

fournir le socle fonctionnel du CRA, de la facturation et du pilotage fiscal

disposer dâ€™un historique fiable, auditable et versionnable de ses engagements

ğŸ‘‰ Une Mission reprÃ©sente un contrat opÃ©rationnel entre :

une entreprise reprÃ©sentÃ©e par lâ€™indÃ©pendant

une entreprise cliente

Une mission peut exister sans reprÃ©sentant humain cÃ´tÃ© client.

3ï¸âƒ£ Actors
Primary Actor

Authenticated User (JWT)

PrÃ©-requis mÃ©tier

Lâ€™utilisateur peut Ãªtre liÃ© Ã  une ou plusieurs Company

Chaque lien User â†” Company porte un rÃ´le

Les rÃ´les possibles sont :

independent

client

âš ï¸ La gestion des rÃ´les utilisateurs est hors scope de ce feature.

ğŸ” RÃ¨gle fondamentale dâ€™accÃ¨s (verrouillÃ©e)

La capacitÃ© de crÃ©er / voir / modifier une Mission dÃ©pend du rÃ´le de la Company de lâ€™utilisateur vis-Ã -vis de la Mission.

Un utilisateur peut :

Ãªtre independent sur certaines missions

Ãªtre client sur dâ€™autres

cumuler les deux rÃ´les via des companies distinctes

AccÃ¨s autorisÃ© si et seulement si :

lâ€™utilisateur appartient Ã  une Company

cette Company est liÃ©e Ã  la Mission via MissionCompany

avec un rÃ´le independent ou client

Toute autre tentative dâ€™accÃ¨s â†’ 404 not_found

4ï¸âƒ£ Architectural Principles (NON NÃ‰GOCIABLES)
ğŸ§± Domain-Driven / Relation-Driven Rule

âŒ Aucune clÃ© Ã©trangÃ¨re mÃ©tier dans les Domain Models

âœ… Toutes les relations passent par des tables dÃ©diÃ©es

Principes

Les entitÃ©s mÃ©tier sont pures

Les relations sont :

explicites

auditables

versionnables

5ï¸âƒ£ Domain Models (purs)
Mission
Champ	Type	Required	Notes
id	UUID	Yes
name	String	Yes
description	Text	No
mission_type	Enum	Yes	time_based | fixed_price
status	Enum	Yes	Voir lifecycle
start_date	Date	Yes
end_date	Date	No	Peut Ãªtre ouverte
daily_rate	Integer	Conditional	Obligatoire si time_based
fixed_price	Integer	Conditional	Obligatoire si fixed_price
currency	String	Yes	ISO 4217 â€” dÃ©faut EUR
created_at	DateTime	Yes
updated_at	DateTime	Yes
deleted_at	DateTime	No	Soft delete

âš ï¸ Aucune rÃ©fÃ©rence vers Company ou User

6ï¸âƒ£ Relation Models (OBLIGATOIRES)
MissionCompany
Champ	Type	Required	Notes
id	UUID	Yes
mission_id	UUID	Yes
company_id	UUID	Yes
role	Enum	Yes	independent | client
created_at	DateTime	Yes
ğŸ”’ Contraintes structurelles

Une Mission DOIT avoir :

exactement 1 Company independent

au plus 1 Company client (optionnelle au moment de la crÃ©ation)

7ï¸âƒ£ Mission Lifecycle (Status)
Enum strict

lead

pending

won

in_progress

completed

Transitions autorisÃ©es (MVP)

lead â†’ pending

pending â†’ won

won â†’ in_progress

in_progress â†’ completed

âš ï¸ Pas de retour arriÃ¨re
âš ï¸ Aucune transition automatique
âš ï¸ Toute transition invalide â†’ 422 invalid_transition

8ï¸âƒ£ Business Rules & Constraints
ğŸ§‘â€ğŸ’¼ Ownership & Access

Lâ€™accÃ¨s Ã  une mission est autorisÃ© uniquement si :

lâ€™utilisateur appartient Ã  une Company

liÃ©e Ã  la Mission avec le rÃ´le independent ou client

Toute tentative dâ€™accÃ¨s sans rÃ´le â†’ 404 not_found

ğŸ—ï¸ CrÃ©ation dâ€™une Mission

Une Mission NE PEUT Ãªtre crÃ©Ã©e que si :

une Company independent existe

lâ€™utilisateur y est rattachÃ©

Cas supportÃ© MVP :

Mission crÃ©Ã©e par un independent

La Company client :

peut exister sans utilisateur

est optionnelle Ã  la crÃ©ation

est liÃ©e uniquement via MissionCompany

âœï¸ Modification dâ€™une Mission
Droit de modification (MVP)

Seul le crÃ©ateur de la Mission peut la modifier

CrÃ©ateur possible :

independent

(crÃ©ation cÃ´tÃ© client prÃ©vue ultÃ©rieurement)

Champs modifiables
Avant won

Tous les champs sont modifiables

AprÃ¨s won (Option A)

Les champs contractuels restent modifiables

Toute modification post-won :

est considÃ©rÃ©e sensible

nâ€™est pas bloquÃ©e

peut dÃ©clencher une notification (voir ci-dessous)

ğŸ”” Notifications post-won

Une notification est envoyÃ©e uniquement si :

une Company client est liÃ©e

un reprÃ©sentant client existe

un email client est prÃ©sent

Sinon :

aucune notification

aucune erreur

comportement silencieux

ğŸ“ Mission Type Rules
time_based

daily_rate requis

fixed_price interdit

fixed_price

fixed_price requis

daily_rate interdit

Violation â†’ 422 invalid_payload

ğŸ“… Dates

start_date â‰¤ end_date

end_date optionnelle

Violation â†’ 422 invalid_payload

ğŸ—‘ï¸ Suppression

Suppression logique uniquement (deleted_at)

Si la mission est liÃ©e Ã  un CRA :

âŒ suppression interdite

âœ… archivage uniquement

Violation â†’ 409 mission_in_use

9ï¸âƒ£ API Scope
Method	Endpoint	Description
POST	/api/v1/missions	CrÃ©er une mission
GET	/api/v1/missions	Lister
GET	/api/v1/missions/:id	DÃ©tail
PATCH	/api/v1/missions/:id	Modifier
DELETE	/api/v1/missions/:id	Archiver
ğŸ”Ÿ Inputs / Outputs
POST /api/v1/missions
{
  "name": "Mission Data Platform",
  "description": "Backend architecture",
  "mission_type": "time_based",
  "status": "won",
  "start_date": "2025-01-01",
  "daily_rate": 600,
  "currency": "EUR",
  "client_company_id": "uuid"
}


âš ï¸ client_company_id est utilisÃ© uniquement pour crÃ©er la relation MissionCompany

Success â€” 201
{
  "id": "uuid",
  "name": "Mission Data Platform",
  "status": "won",
  "mission_type": "time_based"
}

1ï¸âƒ£1ï¸âƒ£ Errors
Status	Code	Description
401	unauthorized	JWT invalide
403	forbidden	User sans Company independent ou sans Company active
404	not_found	Mission inaccessible (aucun rÃ´le)
422	invalid_payload	Validation mÃ©tier
422	invalid_transition	Transition interdite
409	mission_in_use	Mission liÃ©e Ã  un CRA
500	internal_error
1ï¸âƒ£2ï¸âƒ£ Swagger / OpenAPI Requirements

SchÃ©ma Mission

SchÃ©ma MissionCompany

Enums documentÃ©s

Exemples success & error

JWT security scheme

1ï¸âƒ£3ï¸âƒ£ Acceptance Criteria (Gherkin)
Feature: Mission management

Scenario: Create a time-based mission
  Given I am authenticated as an independent
  And my company is linked as independent
  When I create a mission with type time_based
  Then the mission is created successfully

Scenario: Prevent fixed_price without price
  When I create a fixed_price mission without fixed_price
  Then I receive a 422 error

Scenario: Access another company mission
  When I fetch a mission I do not belong to
  Then I receive a 404 response

1ï¸âƒ£4ï¸âƒ£ Definition of Done

RSpec green

Swagger auto-generated

Rubocop OK

Brakeman OK

README updated

PR ready to merge

âœ… Ã‰TAT FINAL
Axe	Statut
Architecture	ğŸŸ¢ VerrouillÃ©e
Domain purity	ğŸŸ¢ RespectÃ©e
Relation-driven	ğŸŸ¢ AppliquÃ©e
ScalabilitÃ©	ğŸŸ¢ Long terme
QualitÃ©	ğŸ† PLATINUM

ğŸ¤– PROMPT MINIMAX-M2 â€” PLATINUM
Feature: Mission Management (FC06)
ğŸ”¹ SYSTEM CONTEXT

You are a senior Ruby on Rails platform engineer.

You work on a Rails 8.1.1 API-only application, running in Docker, using PostgreSQL.

Authentication is based on JWT tokens.

The system follows Domain-Driven Design and Relation-Driven Architecture.

Non-negotiable principles:

Domain models MUST remain pure

NO business foreign keys in domain models

ALL relations MUST be modeled via explicit relation tables

Security, correctness, determinism and auditability are mandatory

You produce production-ready, CI-safe code.

ğŸ”¹ FEATURE CONTRACT (SOURCE OF TRUTH)

FEATURE NAME: Mission Management

This prompt MUST be implemented strictly according to the following contract.
Any ambiguity MUST be flagged before implementation.
NO deviation is allowed.

ğŸ”¹ BUSINESS GOAL

Enable an Independent to:

create and manage professional missions

structure contractual activity

provide the functional base for CRA, billing and fiscal reporting

maintain a reliable, auditable and future-versionable history of engagements

A Mission represents an operational contract between:

an independent company

a client company

A mission MAY exist without a human representative on the client side.

ğŸ”¹ ACTORS & ACCESS MODEL
Primary Actor

Authenticated User (JWT)

Role model

A user can belong to one or more Companies

Each User â†” Company relation carries a role:

independent

client

Role management is OUT OF SCOPE.

Fundamental access rule (LOCKED)

Access to create / view / update a Mission is allowed if and only if:

the user belongs to a Company

this Company is linked to the Mission

via MissionCompany

with role independent OR client

Any other access attempt MUST return 404 not_found.

ğŸ”¹ ARCHITECTURAL RULES (NON NEGOTIABLE)

âŒ NO foreign keys to Company or User in Mission

âœ… ALL relationships via relation tables

Domain models MUST be pure

Relations MUST be explicit, auditable and versionable

ğŸ”¹ DOMAIN MODELS (PURE)
Mission
Field	Type	Required
id	UUID	Yes
name	String	Yes
description	Text	No
mission_type	Enum	Yes (time_based, fixed_price)
status	Enum	Yes
start_date	Date	Yes
end_date	Date	No
daily_rate	Integer	Conditional
fixed_price	Integer	Conditional
currency	String	Yes (ISO 4217, default EUR)
created_at	DateTime	Yes
updated_at	DateTime	Yes
deleted_at	DateTime	No (soft delete)

âš ï¸ MUST NOT reference Company or User.

ğŸ”¹ RELATION MODELS (MANDATORY)
MissionCompany
Field	Type	Required
id	UUID	Yes
mission_id	UUID	Yes
company_id	UUID	Yes
role	Enum	Yes (independent, client)
created_at	DateTime	Yes
Structural constraints

A Mission MUST have:

exactly 1 independent Company

at most 1 client Company (optional at creation)

ğŸ”¹ MISSION LIFECYCLE
Status enum (STRICT)

lead

pending

won

in_progress

completed

Allowed transitions (MVP only)

lead â†’ pending

pending â†’ won

won â†’ in_progress

in_progress â†’ completed

Rules:

NO rollback

NO automatic transitions

Invalid transition â†’ 422 invalid_transition

ğŸ”¹ BUSINESS RULES
Mission creation

A Mission CAN be created ONLY IF:

an independent Company exists

the user belongs to it

MVP scope:

creation by independent only

client company optional

client may exist without any user

Mission modification
Who can modify

ONLY the creator of the Mission (MVP)

Creator is currently always the independent

Editable fields

Before won: all fields editable

After won (Option A):

contract fields remain editable

modification is allowed

modification is considered sensitive

Post-WON notifications

A notification MUST be sent ONLY IF:

a client company is linked

a client representative exists

a client email is present

Otherwise:

NO notification

NO error

silent behavior

Mission type rules
time_based

daily_rate REQUIRED

fixed_price FORBIDDEN

fixed_price

fixed_price REQUIRED

daily_rate FORBIDDEN

Violation â†’ 422 invalid_payload

Date rules

start_date â‰¤ end_date

end_date optional

Violation â†’ 422 invalid_payload

Deletion

Soft delete only

If Mission is linked to a CRA:

deletion FORBIDDEN

archive ONLY

Violation â†’ 409 mission_in_use

ğŸ”¹ API SCOPE
Method	Endpoint
POST	/api/v1/missions
GET	/api/v1/missions
GET	/api/v1/missions/:id
PATCH	/api/v1/missions/:id
DELETE	/api/v1/missions/:id
ğŸ”¹ ERROR CONTRACT
HTTP	Code	Meaning
401	unauthorized	Invalid JWT
403	forbidden	No independent company / no active company
404	not_found	Mission inaccessible (no role)
422	invalid_payload	Business validation
422	invalid_transition	Lifecycle violation
409	mission_in_use	Linked CRA
500	internal_error
ğŸ”¹ OPENAPI REQUIREMENTS

Mission schema

MissionCompany schema

All enums documented

Success & error examples

JWT security scheme

ğŸ”¹ ACCEPTANCE CRITERIA (Gherkin)
Feature: Mission management

Scenario: Create a time-based mission
  Given I am authenticated as an independent
  And my company is linked as independent
  When I create a mission with type time_based
  Then the mission is created successfully

Scenario: Prevent fixed_price without price
  When I create a fixed_price mission without fixed_price
  Then I receive a 422 error

Scenario: Access another company mission
  When I fetch a mission I do not belong to
  Then I receive a 404 response

ğŸ”¹ TASK

Implement the Mission Management feature strictly according to this contract.

Constraints

DO NOT modify existing authentication logic

DO NOT add business foreign keys to domain models

DO NOT bypass relation tables

DO NOT mock business rules

Quality Bar

RSpec MUST be green

Swagger MUST be generated

Rubocop MUST pass

Brakeman MUST pass

Code MUST be production-ready

ğŸ”¹ OUTPUT FORMAT

Return:

The complete implementation

OR explicitly list blocking ambiguities

Do NOT:

add explanations

add commentary

diverge from the contract
