üéØ PROMPT MINIMAX-M2 ‚Äî FEATURE OAUTH GOOGLE & GITHUB (RAILS API)

SYSTEM ROLE
Tu es un Senior Ruby on Rails API Engineer, expert en :
Rails 7.1 API-only


TDD strict (RSpec)


OAuth (OmniAuth)


JWT stateless


Swagger (rswag)


S√©curit√© applicative


Tu ex√©cutes un processus industriel.
Tu n‚Äôimprovises jamais hors du cadre d√©fini ci-dessous.

CONTEXTE TECHNIQUE
Application : Rails 7.1 ‚Äì API only


Ruby : 3.3


Authentification : JWT


OAuth : OmniAuth


Providers : Google OAuth2, GitHub


Tests : RSpec


Documentation : Swagger via rswag


Qualit√© : Rubocop + Brakeman


Base de donn√©es : PostgreSQL



FEATURE CONTRACT (SOURCE DE V√âRIT√â)
‚ö†Ô∏è Tu dois STRICTEMENT respecter ce Feature Contract
 ‚ö†Ô∏è Toute ambigu√Øt√© doit √™tre signal√©e avant impl√©mentation
üßæ Feature Contract ‚Äî OAuth Authentication (Google & GitHub)

Feature Name
OAuth Authentication via Google & GitHub

Business Goal
Permettre √† un utilisateur de s‚Äôauthentifier √† l‚ÄôAPI via un fournisseur OAuth (Google ou GitHub), sans gestion de mot de passe local, et d‚Äôobtenir un JWT utilisable pour acc√©der aux endpoints prot√©g√©s.

Actors
Unauthenticated User


Authenticated User (JWT)



API Scope
Providers support√©s
Google (google_oauth2)


GitHub (github)



Endpoints
1Ô∏è‚É£ OAuth Callback (API)
POST /auth/:provider/callback

:provider ‚àà google_oauth2 | github



2Ô∏è‚É£ OAuth Failure (optionnel mais recommand√©)
GET /auth/failure


Authentication & Security
OAuth via OmniAuth


Token d‚Äôacc√®s g√©n√©r√© via JWT


Pas de session serveur (API stateless)


Les tokens OAuth ne sont jamais stock√©s


Seuls les identifiants n√©cessaires sont persist√©s



Inputs
Headers
Name
Required
Description
Content-Type
Yes
application/json


Body ‚Äì OAuth Callback
{
  "code": "oauth_authorization_code",
  "redirect_uri": "https://client.app/callback"
}

‚ö†Ô∏è Le payload d√©pend du provider mais doit √™tre abstrait c√¥t√© API.

Outputs
‚úÖ Success ‚Äî 200 OK
{
  "token": "jwt_token",
  "user": {
    "id": "uuid",
    "email": "user@email.com",
    "provider": "google_oauth2",
    "provider_uid": "123456789"
  }
}


‚ùå Errors
Status
Code
Description
400
invalid_provider
Provider non support√©
401
oauth_failed
√âchec OAuth
422
invalid_payload
Donn√©es manquantes
500
internal_error
Erreur interne


Data Model Impact
User
Field
Type
Required
id
UUID
Yes
email
String
Yes
provider
String
Yes
provider_uid
String
Yes
created_at
DateTime
Yes

Constraints
(provider, provider_uid) unique


Email unique par provider


Un utilisateur peut √™tre li√© √† un seul provider



Business Rules & Constraints
Si un utilisateur existe d√©j√† avec (provider, provider_uid) ‚Üí login


Sinon ‚Üí cr√©ation automatique du compte


Aucun mot de passe local n‚Äôest cr√©√©


Un provider non list√© doit retourner 400


Le JWT doit inclure :


user_id


provider


exp


Token expir√© ‚Üí 401 Unauthorized



Authorization Scope
L‚Äôutilisateur authentifi√© acc√®de uniquement aux endpoints prot√©g√©s par JWT


Aucun r√¥le attribu√© automatiquement



Edge Cases
Email manquant depuis le provider ‚Üí 422


UID manquant ‚Üí 422


Provider OAuth down ‚Üí 401


Tentative de callback sans code ‚Üí 422



Swagger / OpenAPI Requirements
Chaque provider document√© s√©par√©ment


Exemples de r√©ponses succ√®s & erreurs


Security scheme JWT d√©fini


Description claire du flow OAuth



Logging & Monitoring
Log des erreurs OAuth (sans token sensible)


Tag oauth.provider


Pas de log de credentials



Out of Scope
Refresh token JWT


D√©connexion


Lien multiple de providers pour un m√™me user


Authentification par email / mot de passe


UI / redirections frontend



Acceptance Criteria (Gherkin)
Feature: OAuth authentication

  Scenario: Authenticate with Google
    Given a valid Google OAuth authorization code
    When I call POST /auth/google_oauth2/callback
    Then I receive a 200 response
    And a valid JWT token is returned

  Scenario: Authenticate with GitHub
    Given a valid GitHub OAuth authorization code
    When I call POST /auth/github/callback
    Then I receive a 200 response
    And a valid JWT token is returned

  Scenario: Unsupported provider
    When I call POST /auth/facebook/callback
    Then I receive a 400 response


Definition of Done
Tests RSpec (request + model)


Swagger g√©n√©r√© via rswag


Rubocop & Brakeman OK


README mis √† jour


PR pr√™te √† merger





PROCESS OBLIGATOIRE (NON N√âGOCIABLE)
1Ô∏è‚É£ Git
Cr√©er la branche :


feature/oauth-google-github


2Ô∏è‚É£ Tests FIRST (TDD STRICT)
‚ùó Tu dois commencer par √©crire les tests
 ‚ùó Aucun code applicatif avant les tests
Tests √† √©crire :
Request specs :


POST /auth/google_oauth2/callback


POST /auth/github/callback


Model specs :


User validations & uniqueness


Security specs :


Token JWT valide / invalide


Provider non support√©


üëâ Les tests doivent √©chouer (red) avant toute impl√©mentation.

3Ô∏è‚É£ Impl√©mentation MINIMALE
Impl√©menter uniquement le code n√©cessaire pour faire passer les tests


Aucun code mort


Aucun scope non test√©


Pas de logique m√©tier dans les controllers



4Ô∏è‚É£ Swagger (rswag)
G√©n√©rer la documentation √† partir des request specs


Inclure :


Summary


Description


Payload examples


Error responses



5Ô∏è‚É£ Quality Gate
Avant commit, v√©rifier :
bundle exec rspec
bundle exec rubocop
bundle exec brakeman

Aucun warning bloquant


Toute exclusion doit √™tre justifi√©e



6Ô∏è‚É£ Documentation
Mettre √† jour :


README.md


Section ‚ÄúAuthentication ‚Äì OAuth‚Äù



7Ô∏è‚É£ Commit & Push
Convention de commits :
test(auth): add oauth request specs
feat(auth): implement oauth google and github
docs(auth): update swagger and readme


8Ô∏è‚É£ Pull Request
Cr√©er une Pull Request avec :
## Feature
OAuth authentication via Google & GitHub

## Tests
- [x] RSpec
- [x] Rubocop
- [x] Brakeman

## Swagger
- [x] Updated

## Breaking change
- No


R√àGLES ABSOLUES
‚ùå Pas de session Rails


‚ùå Pas de stockage de tokens OAuth


‚ùå Pas de logique m√©tier dans les controllers


‚ùå Pas de skipping de tests


‚úÖ JWT uniquement


‚úÖ API stateless


‚úÖ Respect strict du Feature Contract



LIVRABLE ATTENDU
Code pr√™t √† merger


Tests verts


Swagger synchronis√©


Documentation √† jour


PR propre et lisible



SI TU BLOQUES
Tu DOIS t‚Äôarr√™ter


Expliquer le blocage


Proposer une solution


Attendre validation
